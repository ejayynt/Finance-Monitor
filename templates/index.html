<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Monitor</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='gold' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23FFD700;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23F0A500;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M50 5 L93.3 30 V80 L50 105 L6.7 80 V30 Z' fill='%23050505' stroke='url(%23gold)' stroke-width='6'/%3E%3Cpath d='M28 65 L45 48 L60 63 L75 33' fill='none' stroke='url(%23gold)' stroke-width='8' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='75' cy='33' r='4' fill='%23FFD700' /%3E%3C/svg%3E" type="image/svg+xml">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        :root {
            --bg-deep: #050505; --bg-radial: #0a0f1c;
            --glass-surface: rgba(20, 25, 40, 0.6); --glass-border: rgba(255, 255, 255, 0.08);
            
            /* DYNAMIC VARIABLES (ATMOSPHERE) */
            --gold-primary: #FFD700; 
            --gold-secondary: #F0A500; 
            --gold-glow: rgba(240, 165, 0, 0.4);
            
            --text-main: #EAEAEA; --text-muted: #8892b0;
            --input-bg: rgba(0, 0, 0, 0.3);
            --success-green: #2ecc71;
            --col-need: #1E90FF; --col-want: #FF6348; --col-save: #FFD700;
        }

        /* ATMOSPHERE: HEAT MODE (When spending > average) */
        body.mode-heat {
            --gold-primary: #FF6B6B; 
            --gold-secondary: #EE5253; 
            --gold-glow: rgba(255, 107, 107, 0.4);
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Outfit', sans-serif; margin: 0; padding: 20px; background-color: var(--bg-deep); background-image: radial-gradient(circle at 50% 0%, #1a2236 0%, var(--bg-deep) 80%); color: var(--text-main); min-height: 100vh; overflow-x: hidden; position: relative; transition: all 1.5s ease; }
        
        /* TYPOGRAPHY PHYSICS: Tabular Nums for alignment */
        .tabular { font-variant-numeric: tabular-nums; letter-spacing: 0px; }

        .hex-bg { position: fixed; z-index: -1; opacity: 0.15; pointer-events: none; transition: all 1.5s ease; }
        .hex-top-right { top: -100px; right: -100px; width: 600px; height: 600px; background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0l25.98 15v30L30 60 4.02 45V15z' stroke='%23F0A500' stroke-width='1' fill='none'/%3E%3C/svg%3E"); mask-image: radial-gradient(circle, black 30%, transparent 70%); animation: float 20s infinite ease-in-out; }
        body.mode-heat .hex-top-right { background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0l25.98 15v30L30 60 4.02 45V15z' stroke='%23FF6B6B' stroke-width='1' fill='none'/%3E%3C/svg%3E"); }

        .hex-bottom-left { bottom: -150px; left: -150px; width: 700px; height: 700px; background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0l25.98 15v30L30 60 4.02 45V15z' stroke='%23F0A500' stroke-width='1' fill='none'/%3E%3C/svg%3E"); mask-image: radial-gradient(circle, black 20%, transparent 70%); animation: floatReverse 25s infinite ease-in-out; }
        body.mode-heat .hex-bottom-left { background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0l25.98 15v30L30 60 4.02 45V15z' stroke='%23FF6B6B' stroke-width='1' fill='none'/%3E%3C/svg%3E"); }

        @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(-20px, 30px); } }
        @keyframes floatReverse { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(20px, -20px); } }

        .app-container { max-width: 1100px; margin: 0 auto; position: relative; z-index: 1; }
        header { text-align: center; margin-bottom: 3rem; transition: all 0.5s; }
        h2 { font-family: 'Space Grotesk', sans-serif; font-size: 2.5rem; margin: 0; background: linear-gradient(135deg, #fff 30%, var(--gold-primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; text-transform: uppercase; font-weight: 700; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.5)); transition: all 1s; }
        .subtitle { font-size: 0.9rem; color: var(--text-muted); margin-top: 5px; letter-spacing: 2px; text-transform: uppercase; font-weight: 400; opacity: 0.8; }

        .card { background: var(--glass-surface); backdrop-filter: blur(16px); border: 1px solid var(--glass-border); border-radius: 24px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 1s; }
        .card:hover { box-shadow: 0 25px 50px rgba(0,0,0,0.5), 0 0 20px rgba(0,0,0,0.1); border-color: rgba(255, 255, 255, 0.15); }

        .tabs { display: flex; justify-content: center; gap: 20px; margin-bottom: 3rem; background: rgba(0,0,0,0.3); padding: 6px; border-radius: 50px; width: fit-content; margin-left: auto; margin-right: auto; border: 1px solid var(--glass-border); }
        .tab-btn { background: transparent; border: none; color: var(--text-muted); padding: 12px 35px; border-radius: 40px; cursor: pointer; font-family: 'Outfit', sans-serif; font-weight: 600; font-size: 0.95rem; transition: all 0.4s; display: flex; align-items: center; gap: 8px; letter-spacing: 0.5px; }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { background: linear-gradient(135deg, var(--gold-secondary), var(--gold-primary)); color: #000; box-shadow: 0 4px 15px var(--gold-glow); }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; max-width: 650px; margin: 0 auto; }
        label { display: block; margin-bottom: 10px; color: var(--gold-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; transition: color 1s; }
        input { width: 100%; padding: 16px; background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 12px; color: #fff; font-family: 'Outfit', sans-serif; font-size: 1rem; transition: all 0.3s; }
        input:focus { border-color: var(--gold-primary); background: rgba(0,0,0,0.5); box-shadow: 0 0 15px var(--gold-glow); }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .date-wrapper { position: relative; }
        input[type="text"]#date_input { cursor: pointer; padding-right: 10px; }
        .custom-select-container { position: relative; width: 100%; }
        .selected-value { background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; transition: all 0.3s; font-weight: 500; display: flex; align-items: center; gap: 10px;}
        .selected-value:hover { border-color: rgba(255,255,255,0.3); background: rgba(0,0,0,0.4); }
        .selected-value.active { border-color: var(--gold-primary); box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        .selected-value::after { content: ''; width: 0.5em; height: 0.5em; border-right: 2px solid var(--gold-primary); border-bottom: 2px solid var(--gold-primary); transform: rotate(45deg); margin-right: 5px; transition: transform 0.3s; }
        .show .selected-value::after { transform: rotate(-135deg); }
        .options-list { position: absolute; top: 120%; left: 0; right: 0; background: #0f1422; border: 1px solid var(--gold-secondary); border-radius: 12px; z-index: 100; max-height: 300px; overflow-y: auto; opacity: 0; pointer-events: none; transform: translateY(-10px); transition: all 0.2s; box-shadow: 0 15px 40px rgba(0,0,0,0.6); }
        .options-list.show { opacity: 1; pointer-events: all; transform: translateY(0); }
        .option-item { padding: 14px 16px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.03); transition: all 0.2s; color: #ccc; display: flex; align-items: center; gap: 12px; }
        .option-item:hover { background: rgba(255,255,255,0.05); color: var(--gold-primary); padding-left: 20px; }
        button.btn-save { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--gold-secondary), #FFC107); color: #000; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer; margin-top: 30px; letter-spacing: 0.5px; text-transform: uppercase; font-family: 'Space Grotesk', sans-serif; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        button.btn-save:hover { transform: translateY(-3px) scale(1.01); box-shadow: 0 15px 30px var(--gold-glow); }
        button.btn-save.success { background: var(--success-green) !important; color: white !important; transform: scale(0.98); box-shadow: 0 0 20px rgba(46, 204, 113, 0.4); }

        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--glass-surface); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; position: relative; overflow: hidden; backdrop-filter: blur(12px); }
        .kpi-card::before { content:''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--gold-secondary); opacity: 0.5; transition: background 1s; }
        .kpi-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .kpi-value { font-family: 'Space Grotesk', sans-serif; font-size: 1.8rem; font-weight: 700; color: #fff; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        /* QUALITY BAR STYLES */
        .q-bar-wrapper { height: 12px; width: 100%; background: rgba(255,255,255,0.05); border-radius: 50px; overflow: hidden; display: flex; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .q-bar-segment { height: 100%; transition: width 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); position: relative; }
        .q-bar-segment:hover { filter: brightness(1.2); }
        .q-legend { display: flex; gap: 20px; font-size: 0.85rem; color: var(--text-muted); }
        .q-item { display: flex; align-items: center; gap: 8px; }
        .q-dot { width: 8px; height: 8px; border-radius: 50%; }

        .dashboard-grid { display: grid; grid-template-columns: 2fr 1.2fr; gap: 30px; }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; .kpi-grid { grid-template-columns: 1fr; } } }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h3.section-title { color: var(--gold-primary); margin: 0; font-family: 'Space Grotesk', sans-serif; font-weight: 400; letter-spacing: 2px; text-transform: uppercase; font-size: 1rem; opacity: 0.9; transition: color 1s; }
        
        .chart-controls { display: flex; align-items: center; gap: 15px; }
        .chart-toggles { display: flex; gap: 5px; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 8px; }
        .chart-toggle-btn { background: transparent; border: none; color: var(--text-muted); padding: 6px 12px; font-size: 0.75rem; border-radius: 6px; cursor: pointer; text-transform: uppercase; font-weight: 600; font-family: 'Outfit', sans-serif; transition: all 0.2s; }
        .chart-toggle-btn:hover { color: #fff; }
        .chart-toggle-btn.active { background: var(--gold-secondary); color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; user-select: none; }
        .checkbox-wrapper input { display: none; }
        .checkbox-custom { width: 16px; height: 16px; border: 1px solid var(--gold-secondary); border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .checkbox-wrapper input:checked + .checkbox-custom { background: var(--gold-secondary); }
        .checkbox-wrapper input:checked + .checkbox-custom::after { content:'✔'; font-size: 10px; color: black; }

        .styled-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .styled-table th { color: var(--text-muted); padding: 10px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 500; }
        .styled-table td { background: rgba(255,255,255,0.03); padding: 15px; font-size: 0.95rem; border-top: 1px solid rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.02); vertical-align: middle; position: relative; }
        .styled-table tr.clickable-row { cursor: pointer; transition: all 0.2s; }
        .styled-table tr.clickable-row:hover td { background: rgba(255,255,255,0.06); transform: scale(1.01); border-color: rgba(255, 255, 255, 0.1); }
        .styled-table tr td:first-child { border-radius: 10px 0 0 10px; border-left: 1px solid rgba(255,255,255,0.02); }
        .styled-table tr td:last-child { border-radius: 0 10px 10px 0; border-right: 1px solid rgba(255,255,255,0.02); }
        .styled-table tr:last-child td { background: rgba(255,255,255,0.05); color: var(--gold-primary); font-weight: 700; border-color: rgba(255, 255, 255, 0.1); }
        .td-cat-wrapper { display: flex; align-items: center; gap: 10px; }
        
        #detail-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); z-index: 10000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #detail-modal.active { opacity: 1; pointer-events: all; }
        .modal-content { background: #0f1422; border: 1px solid var(--gold-secondary); border-radius: 24px; padding: 30px; width: 90%; max-width: 600px; box-shadow: 0 25px 80px rgba(0,0,0,0.8); transform: translateY(20px); transition: transform 0.3s; max-height: 80vh; display: flex; flex-direction: column; }
        #detail-modal.active .modal-content { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .modal-title { font-family: 'Space Grotesk'; font-size: 1.5rem; color: var(--gold-primary); display: flex; align-items: center; gap: 10px; }
        .close-modal { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .close-modal:hover { color: #fff; }
        .modal-list { overflow-y: auto; padding-right: 10px; flex: 1; }
        .detail-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .detail-item:hover { background: rgba(255,255,255,0.03); }
        .detail-left { display: flex; flex-direction: column; gap: 4px; }
        .detail-sub { color: #fff; font-weight: 500; font-size: 1rem; }
        .detail-meta { font-size: 0.8rem; color: var(--text-muted); display: flex; gap: 10px; }
        .detail-right { display: flex; align-items: center; gap: 15px; }
        .detail-amt { font-family: 'Space Grotesk'; font-size: 1.1rem; color: var(--gold-primary); }
        .delete-btn { width: 32px; height: 32px; border-radius: 8px; border: 1px solid rgba(255, 71, 87, 0.5); color: #ff4757; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; background: rgba(255, 71, 87, 0.1); }
        .delete-btn:hover { background: #ff4757; color: white; }

        /* FIXED TOOLTIP */
        #chartjs-tooltip { opacity: 0; position: absolute; background: rgba(15, 20, 34, 0.98); color: #fff; border: 1px solid var(--gold-secondary); border-radius: 12px; pointer-events: none; transition: opacity 0.15s ease; box-shadow: 0 10px 40px rgba(0,0,0,0.8); font-family: 'Outfit', sans-serif; padding: 12px 16px; z-index: 9999; min-width: 140px; backdrop-filter: blur(10px); transform: translate(-50%, -120%); }
        #chartjs-tooltip .t-header { color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px; }
        #chartjs-tooltip .t-body { font-size: 0.9rem; font-weight: 400; color: #ccc; font-family: 'Space Grotesk', sans-serif; display: flex; justify-content: space-between; gap: 12px; margin-bottom: 4px; }
        #chartjs-tooltip .t-body span.val { color: var(--gold-primary); font-weight: 700; }
        #chartjs-tooltip::after { content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px; border-width: 6px 6px 0; border-style: solid; border-color: var(--gold-secondary) transparent transparent transparent; }

        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-muted); border: 1px dashed var(--glass-border); border-radius: 20px; background: rgba(0,0,0,0.2); }
        .empty-icon { font-size: 3rem; color: var(--gold-secondary); margin-bottom: 1rem; opacity: 0.5; }
        .filters { display: flex; gap: 15px; margin-bottom: 25px; align-items: center; justify-content: flex-end;}
        .filter-group { width: 140px; }
        .flatpickr-calendar { background: #0f1422 !important; border: 1px solid var(--gold-secondary) !important; box-shadow: 0 15px 40px rgba(0,0,0,0.8) !important; font-family: 'Outfit', sans-serif !important; border-radius: 12px !important; }
        .flatpickr-months .flatpickr-month { background: transparent !important; color: var(--gold-primary) !important; fill: var(--gold-primary) !important; }
        .flatpickr-current-month .flatpickr-monthDropdown-months { background: #0f1422 !important; }
        .flatpickr-weekdays { background: transparent !important; }
        span.flatpickr-weekday { color: var(--text-muted) !important; font-weight: 600 !important; }
        .flatpickr-day { color: #EAEAEA !important; border-radius: 8px !important; }
        .flatpickr-day:hover { background: rgba(240, 165, 0, 0.15) !important; border-color: transparent !important; }
        .flatpickr-day.today { border-color: var(--gold-secondary) !important; }
        .flatpickr-day.selected { background: var(--gold-primary) !important; color: #000 !important; border-color: var(--gold-primary) !important; font-weight: 700 !important; }
        .flatpickr-months .flatpickr-prev-month, .flatpickr-months .flatpickr-next-month { fill: var(--gold-primary) !important; }
        .flatpickr-footer { border-top: 1px solid rgba(255,255,255,0.1); padding: 8px; display: flex; justify-content: center; margin-top: 5px; }
        .flatpickr-today-btn { background: rgba(240, 165, 0, 0.1); border: 1px solid var(--gold-secondary); color: var(--gold-primary); padding: 6px 20px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; font-family: 'Space Grotesk', sans-serif; transition: all 0.2s; width: 100%; }
        .flatpickr-today-btn:hover { background: var(--gold-primary); color: #000; box-shadow: 0 0 10px var(--gold-glow); }
        
        #toast { visibility: hidden; min-width: 300px; background: rgba(10, 10, 10, 0.9); color: var(--gold-primary); text-align: center; border-radius: 50px; padding: 16px 24px; position: fixed; z-index: 200; left: 50%; top: 30px; transform: translateX(-50%); border: 1px solid var(--gold-secondary); box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-weight: 600; font-family: 'Space Grotesk', sans-serif; backdrop-filter: blur(10px); }
        #toast.show { visibility: visible; animation: slideDown 0.4s, fadeOut 0.5s 2.5s forwards; }
        .hidden { display: none !important; }
        @keyframes slideDown { from {top: -50px; opacity: 0;} to {top: 30px; opacity: 1;} }
        @keyframes fadeOut { to { opacity: 0; pointer-events: none;} }
        @keyframes spin { 100% { transform:rotate(360deg); } }
        .c-icon { width: 20px; height: 20px; fill: none; stroke: #F0A500; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; border: 2px solid var(--bg-deep); }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-secondary); }

        /* LIVING DONUT LABEL - FIXED ALIGNMENT */
        .donut-label {
            position: absolute; top: 50%; left: 42%; /* Adjusted left to account for legend */
            transform: translate(-50%, -50%); text-align: center; pointer-events: none; white-space: nowrap;
        }
        .donut-label .dl-sub { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .donut-label .dl-main { font-family: 'Space Grotesk'; font-size: 1.8rem; font-weight: 700; color: #fff; line-height: 1; }
    </style>
</head>
<body>

<svg width="0" height="0" style="position: absolute;">
    <defs>
        <symbol id="icon-Food" viewBox="0 0 24 24"><path d="M4 10c0 4.418 3.582 8 8 8s8-3.582 8-8H4z"/><path d="M6 4v3"/><path d="M12 4v3"/><path d="M18 4v3"/></symbol>
        <symbol id="icon-Utilities" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></symbol>
        <symbol id="icon-Travel" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v3"/><path d="M12 19v3"/><path d="M2 12h3"/><path d="M19 12h3"/><path d="M4.93 4.93l2.12 2.12"/><path d="M16.95 16.95l2.12 2.12"/><path d="M19.07 4.93l-2.12 2.12"/><path d="M7.05 16.95l-2.12 2.12"/></symbol>
        <symbol id="icon-Lifestyle" viewBox="0 0 24 24"><path d="M6 6h12v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V6z"/><path d="M16 6V4a4 4 0 0 0-8 0v2"/><line x1="12" y1="12" x2="12" y2="12.01"/></symbol>
        <symbol id="icon-Investment" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></symbol>
        <symbol id="icon-Burn" viewBox="0 0 24 24"><path d="M8.56 2.75c4.37 6.03 6.02 9.42 8.03 17.72m2.54-5.38c-.27-8.07-2.69-10.24-5.94-14.84m-8.91 8.91c5.27 1.63 7.03 4.3 7.03 8.34"/></symbol>
        <symbol id="icon-Velocity" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></symbol>
        <symbol id="icon-Runway" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></symbol>
        <symbol id="icon-Empty" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M12 10a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></symbol>
    </defs>
</svg>

<div class="hex-bg hex-top-right"></div>
<div class="hex-bg hex-bottom-left"></div>
<div id="toast"></div>

<div id="detail-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modal-title"></div>
            <button class="close-modal" onclick="closeModal()"><i class="ph ph-x"></i></button>
        </div>
        <div class="modal-list" id="modal-list"></div>
    </div>
</div>

<div class="app-container">
    <header>
        <h2>Finance Monitor</h2>
        <div class="subtitle">Personal Wealth Command</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('entry')">
            <i class="ph ph-plus-circle" style="font-size:1.2rem"></i> ADD ENTRY
        </button>
        <button class="tab-btn" onclick="switchTab('dashboard')">
            <i class="ph ph-squares-four" style="font-size:1.2rem"></i> DASHBOARD
        </button>
    </div>

    <div id="entry-tab">
        <div class="card" style="max-width: 700px; margin: 0 auto; position: relative; overflow: hidden;">
            <div style="position:absolute; top:-50px; right:-50px; width:150px; height:150px; background:var(--gold-primary); filter:blur(80px); opacity:0.1; pointer-events:none;"></div>

            <div class="form-grid">
                <div>
                    <label>Category</label>
                    <div class="custom-select-container" id="cat-container">
                        <div class="selected-value" onclick="toggleDropdown('cat')">
                            <span><svg class="c-icon" style="margin-right:8px; width:16px; height:16px;"><use href="#icon-Food"></use></svg> Food</span>
                        </div>
                        <div class="options-list" id="options-cat"></div>
                        <input type="hidden" id="cat" value="Food"> 
                    </div>
                </div>

                <div>
                    <label>Sub-Category</label>
                    <div class="custom-select-container" id="subcat-container">
                        <div class="selected-value" onclick="toggleDropdown('subcat')">Select Sub-Cat</div>
                        <div class="options-list" id="options-subcat"></div>
                        <input type="hidden" id="subcat">
                    </div>
                </div>
                
                <div>
                    <label>Amount (&#8377;)</label>
                    <input type="text" id="amount" placeholder="0" inputmode="numeric">
                </div>
                <div>
                    <label>Surcharge / Tax (&#8377;)</label>
                    <input type="text" id="surcharge" placeholder="0" inputmode="numeric">
                </div>

                <div class="date-wrapper">
                    <label>Date</label>
                    <input type="text" id="date_input" placeholder="Select Date">
                </div>

                <div class="custom-select-container" id="nec-container">
                    <label>Necessity Type</label>
                    <div class="selected-value" onclick="toggleDropdown('necessity')">Need (Essential)</div>
                    <div class="options-list" id="options-necessity">
                        <div class="option-item" onclick="selectOption('necessity', 'Need', '<span style=color:#2ecc71>●</span> &nbsp; Need (Essential)')"><span style="color:#2ecc71">●</span> &nbsp; Need (Essential)</div>
                        <div class="option-item" onclick="selectOption('necessity', 'Want', '<span style=color:#e74c3c>●</span> &nbsp; Want (Luxury/Impulse)')"><span style="color:#e74c3c">●</span> &nbsp; Want (Luxury/Impulse)</div>
                    </div>
                    <input type="hidden" id="necessity" value="Need">
                </div>
                
                <div style="grid-column: span 2;">
                    <label>Note</label>
                    <input type="text" id="desc" placeholder="Details (e.g., SIP, Starbucks, Swiggy)...">
                </div>
            </div>
            
            <button class="btn-save" onclick="submitExpense()">Confirm Transaction</button>
        </div>
    </div>

    <div id="dashboard-tab" class="hidden">
        
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label"><svg class="c-icon" style="width:14px; height:14px;"><use href="#icon-Burn"></use></svg> Monthly Burn</div>
                <div class="kpi-value tabular" id="kpi-total">₹0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label"><svg class="c-icon" style="width:14px; height:14px;"><use href="#icon-Velocity"></use></svg> Daily Velocity</div>
                <div class="kpi-value tabular" id="kpi-daily">₹0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label"><svg class="c-icon" style="width:14px; height:14px;"><use href="#icon-Runway"></use></svg> Projected Total</div>
                <div class="kpi-value tabular" id="kpi-projected" style="color:var(--text-muted)">₹0</div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 30px;">
            <h3 class="section-title" style="text-align: left; margin-bottom: 15px; display: flex; justify-content: space-between; align-items:center;">
                Quality of Spend
                <span style="font-size: 0.7rem; color: var(--text-muted); font-family: 'Outfit'; text-transform: uppercase; letter-spacing: 1px; opacity:0.7;">Target: 50/30/20</span>
            </h3>
            
            <div class="q-bar-wrapper">
                <div id="bar-needs" class="q-bar-segment" style="width: 0%; background: var(--col-need);" onmousemove="showQTooltip(event, 'need')" onmouseout="hideQTooltip()"></div>
                <div id="bar-wants" class="q-bar-segment" style="width: 0%; background: var(--col-want);" onmousemove="showQTooltip(event, 'want')" onmouseout="hideQTooltip()"></div>
                <div id="bar-saves" class="q-bar-segment" style="width: 0%; background: var(--col-save);" onmousemove="showQTooltip(event, 'save')" onmouseout="hideQTooltip()"></div>
            </div>
            
            <div class="q-legend">
                <div class="q-item"><div class="q-dot" style="background:var(--col-need)"></div> Needs <span id="val-need" class="tabular" style="color:#fff; font-weight:600; margin-left:4px;">0%</span></div>
                <div class="q-item"><div class="q-dot" style="background:var(--col-want)"></div> Wants <span id="val-want" class="tabular" style="color:#fff; font-weight:600; margin-left:4px;">0%</span></div>
                <div class="q-item"><div class="q-dot" style="background:var(--col-save)"></div> Savings <span id="val-save" class="tabular" style="color:#fff; font-weight:600; margin-left:4px;">0%</span></div>
            </div>
        </div>

        <div class="filters">
            <div style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; margin-right:10px;">View Data:</div>
            <div class="custom-select-container filter-group">
                <div class="selected-value" id="display-year" onclick="toggleDropdown('year')">Year</div>
                <div class="options-list" id="options-year"></div>
                <input type="hidden" id="filter-year">
            </div>
            <div class="custom-select-container filter-group">
                <div class="selected-value" id="display-month" onclick="toggleDropdown('month')">Month</div>
                <div class="options-list" id="options-month"></div>
                <input type="hidden" id="filter-month">
            </div>
        </div>

        <div id="dashboard-content">
            <div class="dashboard-grid">
                <div class="card">
                    <h3 class="section-title">Expense Breakdown</h3>
                    <div style="height: 320px; position: relative;">
                        <canvas id="donutChart"></canvas>
                        <div class="donut-label" id="donut-center">
                            <div class="dl-sub">Total</div>
                            <div class="dl-main tabular" id="donut-val">₹0</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="section-title">Statement Details</h3>
                    <table class="styled-table">
                        <thead><tr><th>Category</th><th style="text-align:right">Total</th></tr></thead>
                        <tbody id="breakdown-table-body"></tbody>
                    </table>
                </div>
            </div>

            <br>

            <div class="card">
                <div class="section-header">
                    <h3 class="section-title">Spending Velocity</h3>
                    <div class="chart-controls">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="hide-fixed" onchange="renderDashboard()">
                            <span class="checkbox-custom"></span>
                            Hide Fixed
                        </label>
                        <div class="chart-toggles">
                            <button class="chart-toggle-btn active" id="btn-mode-month" onclick="setChartMode('month')">Daily</button>
                            <button class="chart-toggle-btn" id="btn-mode-year" onclick="setChartMode('year')">Annual</button>
                        </div>
                    </div>
                </div>
                <div style="height: 300px;">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>

        <div id="empty-state" class="hidden">
            <div class="empty-state">
                <svg class="c-icon empty-icon" style="width:60px; height:60px; margin: 0 auto; display:block;"><use href="#icon-Empty"></use></svg>
                <h3 style="color:var(--text-main); margin-bottom: 5px;">Vault Secure</h3>
                <p>No transactions found for this period.</p>
            </div>
        </div>

    </div>
</div>

<div id="chartjs-tooltip"></div>

<script>
    const categoryData = {
        "Food": ["Grocery (Healthy)", "Ordering In", "Dining Out (Healthy)", "Junk / Cravings"],
        "Utilities": ["Rent", "Mobile/Data", "Electricity"], 
        "Travel": ["Public (Metro/Bus)", "Auto/Cab", "Fuel"],
        "Lifestyle": ["Clothes/Gear", "Electronics", "Medical/Hygiene", "Social / Gifting"],
        "Investment": ["SIP", "Fixed Deposit", "RD", "Lumpsum"]
    };

    const FIXED_COST_SUBCATS = ["Rent", "SIP", "Fixed Deposit", "RD", "EMI"];

    let allExpenses = [];
    let donutChartInstance = null;
    let lineChartInstance = null;
    let currentChartMode = 'month';
    let donutBreakdownData = {}; 
    let currentFilteredData = [];
    let qualityData = { need: 0, want: 0, save: 0, total: 0, needPct: 0, wantPct: 0, savePct: 0 };
    let currentMonthTotal = 0; // For Donut Center

    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    function evaluateMath(str) {
        let clean = str.replace(/,/g, '').replace(/\s/g, '');
        if (!/^[0-9+\-.]+$/.test(clean)) return null; 
        try { return new Function('return ' + clean)(); } 
        catch { return null; }
    }

    const externalTooltipHandler = (context) => {
        const {chart, tooltip} = context;
        const tooltipEl = document.getElementById('chartjs-tooltip');
        if (tooltip.opacity === 0) { tooltipEl.style.opacity = 0; return; }

        if (tooltip.body) {
            const titleLines = tooltip.title || [];
            const bodyLines = tooltip.body.map(b => b.lines);
            let innerHtml = '';
            
            titleLines.forEach(title => {
                let displayTitle = title;
                if(currentChartMode === 'month' && !isNaN(title) && chart.canvas.id === 'lineChart') {
                    const mName = document.querySelector('#display-month').innerText;
                    displayTitle = `${mName} ${title}`;
                }
                innerHtml += '<div class="t-header">' + displayTitle + '</div>';
            });

            if (chart.canvas.id === 'donutChart') {
                // Donut logic handled by onHover for center text, tooltip can stay or be simple
                const category = titleLines[0];
                const subcats = donutBreakdownData[category] || {};
                const sortedSubs = Object.entries(subcats).sort((a,b) => b[1] - a[1]);
                sortedSubs.forEach(([name, val]) => {
                    innerHtml += `<div class="t-body" style="font-size:0.9rem;">${name} <span class="val tabular">${fmtMoney(val)}</span></div>`;
                });
            } else {
                bodyLines.forEach(body => {
                    const parts = body[0].split(':');
                    const label = parts[0];
                    const value = parts[1] || '';
                    innerHtml += `<div class="t-body">${label} <span class="val tabular">${value}</span></div>`; 
                });
            }
            tooltipEl.innerHTML = innerHtml;
        }

        const position = chart.canvas.getBoundingClientRect();
        const left = position.left + window.pageXOffset + tooltip.caretX;
        const top = position.top + window.pageYOffset + tooltip.caretY;
        tooltipEl.style.opacity = 1;
        tooltipEl.style.left = left + 'px';
        tooltipEl.style.top = top + 'px';
    };

    function showQTooltip(e, type) {
        const tooltipEl = document.getElementById('chartjs-tooltip');
        let label, amount, pct, target, color;
        
        if(type === 'need') { label = "NEEDS"; amount = qualityData.need; pct = qualityData.needPct; target = "50%"; color = "var(--col-need)"; }
        else if(type === 'want') { label = "WANTS"; amount = qualityData.want; pct = qualityData.wantPct; target = "30%"; color = "var(--col-want)"; }
        else { label = "SAVINGS"; amount = qualityData.save; pct = qualityData.savePct; target = "20%"; color = "var(--col-save)"; }

        let innerHtml = `
            <div class="t-header" style="color:${color}">${label}</div>
            <div class="t-body" style="margin-bottom:2px;">Amount <span class="val tabular">${fmtMoney(amount)}</span></div>
            <div class="t-body" style="margin-bottom:2px;">Current <span class="val tabular">${pct}%</span></div>
            <div class="t-body" style="opacity:0.6; font-size:0.8rem;">Target <span class="val tabular">${target}</span></div>
        `;
        tooltipEl.innerHTML = innerHtml;
        tooltipEl.style.opacity = 1;
        tooltipEl.style.left = e.clientX + 'px';
        tooltipEl.style.top = (e.clientY - 20) + 'px';
    }
    
    function hideQTooltip() { document.getElementById('chartjs-tooltip').style.opacity = 0; }

    function init() {
        flatpickr("#date_input", { 
            dateFormat: "Y-m-d", defaultDate: "today", theme: "dark", disableMobile: "true",
            onReady: function(selectedDates, dateStr, instance) {
                const footer = document.createElement("div"); footer.classList.add("flatpickr-footer");
                const btn = document.createElement("button"); btn.classList.add("flatpickr-today-btn");
                btn.innerText = "JUMP TO TODAY";
                btn.addEventListener("click", () => { instance.setDate(new Date(), true); instance.close(); });
                footer.appendChild(btn); instance.calendarContainer.appendChild(footer);
            }
        });

        ['amount', 'surcharge'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', function(e) {
                if (!/[+\-]/.test(this.value)) {
                    let val = this.value.replace(/[^0-9.]/g, ''); 
                    if(val) {
                        if(val === "0" && e.inputType !== "insertText") { this.value = ""; return; } 
                        const parts = val.split('.');
                        parts[0] = Number(parts[0]).toLocaleString('en-IN'); 
                        this.value = parts.join('.');
                    }
                }
            });
            el.addEventListener('blur', function() {
                if (/[+\-]/.test(this.value)) {
                    const result = evaluateMath(this.value);
                    if (result !== null) { this.value = result.toLocaleString('en-IN'); }
                }
            });
            el.addEventListener('keydown', function(e) { if(e.key === 'Enter') this.blur(); });
        });

        const catList = document.getElementById('options-cat');
        Object.keys(categoryData).forEach(cat => {
            const iconId = `icon-${cat}`;
            catList.innerHTML += `<div class="option-item" onclick="selectOption('cat', '${cat}')"><svg class="c-icon"><use href="#${iconId}"></use></svg> ${cat}</div>`;
        });
        selectOption('cat', 'Food');

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.custom-select-container')) {
                document.querySelectorAll('.options-list').forEach(el => {
                    el.classList.remove('show');
                    if(el.previousElementSibling) el.previousElementSibling.classList.remove('active');
                    el.parentElement.classList.remove('show');
                });
            }
            const modal = document.getElementById('detail-modal');
            if (e.target === modal) closeModal();
        });

        Chart.defaults.color = '#8892b0';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
        Chart.defaults.font.family = "'Space Grotesk', sans-serif";
        Chart.defaults.plugins.tooltip.enabled = false;
        Chart.defaults.plugins.tooltip.external = externalTooltipHandler;

        fetchDataAndRender();
    }

    function toggleDropdown(id) {
        document.querySelectorAll('.options-list').forEach(el => { if(el.id !== `options-${id}`) { el.classList.remove('show'); el.parentElement.classList.remove('show'); } });
        const list = document.getElementById(`options-${id}`);
        list.classList.toggle('show'); list.parentElement.classList.toggle('show');
    }

    function selectOption(type, value, displayValue = null) {
        const container = document.getElementById(`options-${type}`).parentElement;
        if (type === 'cat') {
            container.querySelector('.selected-value').innerHTML = `<span><svg class="c-icon" style="margin-right:8px; width:16px; height:16px;"><use href="#icon-${value}"></use></svg> ${value}</span>`;
        } else {
            container.querySelector('.selected-value').innerHTML = displayValue || value;
        }
        document.getElementById(type).value = value;
        document.getElementById(`options-${type}`).classList.remove('show');
        container.classList.remove('show');
        if (type === 'cat') updateSubcats(value);
    }
    
    function selectFilterOption(type, value, displayValue) {
        const container = document.getElementById(`options-${type}`).parentElement;
        container.querySelector('.selected-value').innerHTML = displayValue;
        document.getElementById(`filter-${type}`).value = value;
        document.getElementById(`options-${type}`).classList.remove('show');
        container.classList.remove('show');
        if(type === 'year') updateMonthFilter(value);
        else renderDashboard();
    }

    function updateSubcats(category) {
        const subList = document.getElementById('options-subcat');
        subList.innerHTML = "";
        const subs = categoryData[category] || [];
        subs.forEach(sub => {
            subList.innerHTML += `<div class="option-item" onclick="selectOption('subcat', '${sub}')">${sub}</div>`;
        });
        if (subs.length > 0) selectOption('subcat', subs[0]);
    }

    function populateFilters(data) {
        const years = [...new Set(data.map(e => new Date(e.date).getFullYear()))].sort((a,b)=>b-a);
        if (years.length === 0) years.push(new Date().getFullYear());
        const yearList = document.getElementById('options-year'); yearList.innerHTML = "";
        years.forEach(y => { yearList.innerHTML += `<div class="option-item" onclick="selectFilterOption('year', '${y}', '${y}')">${y}</div>`; });
        const currentSelectedYear = document.getElementById('filter-year').value;
        if (!years.includes(parseInt(currentSelectedYear))) selectFilterOption('year', years[0], years[0]);
        else updateMonthFilter(currentSelectedYear);
    }

    function updateMonthFilter(year) {
        let availableMonths = new Set();
        allExpenses.forEach(e => { if(new Date(e.date).getFullYear() == year) availableMonths.add(new Date(e.date).getMonth()); });
        let monthsArr = [...availableMonths].sort((a,b)=>a-b);
        if(monthsArr.length === 0 && year == new Date().getFullYear()) monthsArr.push(new Date().getMonth());
        
        const monthList = document.getElementById('options-month'); monthList.innerHTML = "";
        if(monthsArr.length === 0) {
            document.querySelector('#display-month').innerText = "No Data";
            document.getElementById('filter-month').value = -1;
            renderDashboard(); return;
        }
        monthsArr.forEach(mIndex => {
            const mName = monthNames[mIndex];
            monthList.innerHTML += `<div class="option-item" onclick="selectFilterOption('month', '${mIndex+1}', '${mName.substring(0,3).toUpperCase()}')">${mName}</div>`;
        });
        const lastMonthIdx = monthsArr[monthsArr.length - 1];
        selectFilterOption('month', lastMonthIdx + 1, monthNames[lastMonthIdx].substring(0,3).toUpperCase());
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('entry-tab').classList.add('hidden');
        document.getElementById('dashboard-tab').classList.add('hidden');
        if(tab === 'entry') { document.querySelector('.tab-btn:first-child').classList.add('active'); document.getElementById('entry-tab').classList.remove('hidden'); }
        else { document.querySelector('.tab-btn:last-child').classList.add('active'); document.getElementById('dashboard-tab').classList.remove('hidden'); fetchDataAndRender(); }
    }

    function setChartMode(mode) {
        currentChartMode = mode;
        document.querySelectorAll('.chart-toggle-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-mode-${mode}`).classList.add('active');
        renderDashboard(); 
    }

    async function submitExpense() {
        const btn = document.querySelector('.btn-save');
        const originalText = btn.innerHTML;
        const amtEl = document.getElementById('amount');
        if (/[+\-]/.test(amtEl.value)) amtEl.value = evaluateMath(amtEl.value).toLocaleString('en-IN');
        
        const rawAmount = amtEl.value.replace(/,/g, '');
        
        const data = {
            date: document.getElementById('date_input').value,
            category: document.getElementById('cat').value,
            subcategory: document.getElementById('subcat').value,
            amount: parseFloat(rawAmount) || 0,
            surcharge: parseFloat(document.getElementById('surcharge').value) || 0,
            necessity: document.getElementById('necessity').value,
            desc: document.getElementById('desc').value
        };

        if(data.amount <= 0) { alert("Please enter a valid amount"); return; }

        btn.innerHTML = `<i class="ph ph-spinner" style="animation: spin 1s infinite linear"></i>`;
        
        try {
            await fetch('/api/expenses', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            btn.classList.add('success');
            btn.innerHTML = `<i class="ph ph-check" style="font-size:1.5rem"></i>`;
            setTimeout(() => {
                btn.classList.remove('success');
                btn.innerHTML = originalText;
                document.getElementById('amount').value = ''; 
                document.getElementById('surcharge').value = ''; 
                document.getElementById('desc').value = '';
            }, 1500);
        } catch(e) { alert("Error saving data"); btn.innerHTML = originalText; }
    }

    function openCategoryModal(category) {
        const modal = document.getElementById('detail-modal');
        const titleEl = document.getElementById('modal-title');
        const listEl = document.getElementById('modal-list');
        titleEl.innerHTML = `<svg class="c-icon" style="width:24px;height:24px;"><use href="#icon-${category}"></use></svg> ${category}`;
        listEl.innerHTML = "";
        const catData = currentFilteredData.filter(e => e.category === category);
        if(catData.length === 0) {
            listEl.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:20px;">No transactions found.</div>`;
        } else {
            catData.sort((a, b) => new Date(b.date) - new Date(a.date));
            catData.forEach(entry => {
                const amt = parseFloat(entry.amount) + parseFloat(entry.surcharge);
                const el = document.createElement('div');
                el.className = 'detail-item';
                el.innerHTML = `
                    <div class="detail-left">
                        <div class="detail-sub">${entry.subcategory}</div>
                        <div class="detail-meta">
                            <span>${entry.date}</span>
                            ${entry.desc ? `<span style="opacity:0.6; border-left:1px solid #444; padding-left:10px;">${entry.desc}</span>` : ''}
                        </div>
                    </div>
                    <div class="detail-right">
                        <div class="detail-amt tabular">${fmtMoney(amt)}</div>
                        <div class="delete-btn" onclick="deleteExpense(${entry.id}, this.closest('.detail-item'))"><i class="ph ph-trash"></i></div>
                    </div>
                `;
                listEl.appendChild(el);
            });
        }
        modal.classList.add('active');
    }

    function closeModal() {
        document.getElementById('detail-modal').classList.remove('active');
        renderDashboard(); 
    }

    async function deleteExpense(id, element) {
        if(!confirm("Are you sure?")) return;
        element.style.opacity = '0.3';
        try {
            const res = await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
            if(res.ok) { element.style.display = 'none'; fetchDataAndRender(); } 
            else { alert("Failed"); element.style.opacity = '1'; }
        } catch(e) { alert("Error"); element.style.opacity = '1'; }
    }

    async function fetchDataAndRender() {
        const res = await fetch('/api/expenses');
        allExpenses = await res.json();
        populateFilters(allExpenses);
    }

    function renderDashboard() {
        const selYear = parseInt(document.getElementById('filter-year').value);
        const selMonth = parseInt(document.getElementById('filter-month').value);
        const hideFixed = document.getElementById('hide-fixed').checked;
        const dashboardContent = document.getElementById('dashboard-content');
        const emptyState = document.getElementById('empty-state');
        const kpiGrid = document.querySelector('.kpi-grid');

        if(isNaN(selYear) || isNaN(selMonth) || selMonth === -1) {
            dashboardContent.classList.add('hidden'); kpiGrid.classList.add('hidden'); emptyState.classList.remove('hidden'); return;
        }

        const monthlyData = allExpenses.filter(e => {
            const d = new Date(e.date);
            return d.getFullYear() === selYear && (d.getMonth() + 1) === selMonth;
        });
        currentFilteredData = monthlyData;

        if (monthlyData.length === 0) {
            dashboardContent.classList.add('hidden'); kpiGrid.classList.add('hidden'); emptyState.classList.remove('hidden');
        } else {
            dashboardContent.classList.remove('hidden'); kpiGrid.classList.remove('hidden'); emptyState.classList.add('hidden');
            const yearlyData = allExpenses.filter(e => new Date(e.date).getFullYear() === selYear);
            
            updateKPIs(monthlyData, selMonth, selYear, allExpenses);
            updateQualityBar(monthlyData);
            updateDonutAndTable(monthlyData);
            
            let chartData = currentChartMode === 'month' ? monthlyData : yearlyData;
            if (hideFixed) {
                chartData = chartData.filter(e => !FIXED_COST_SUBCATS.includes(e.subcategory) && e.category !== "Investment");
            }

            if (currentChartMode === 'month') {
                updateLineChartDaily(chartData, selMonth, selYear);
            } else {
                updateLineChartAnnual(chartData);
            }
        }
    }

    function updateKPIs(data, selMonth, selYear, fullDataset) {
        let total = 0;
        let fixedTotalThisMonth = 0;
        let variableTotal = 0;

        data.forEach(e => {
            const amt = (parseFloat(e.amount) + parseFloat(e.surcharge));
            total += amt;
            if (FIXED_COST_SUBCATS.includes(e.subcategory) || e.category === "Investment") {
                fixedTotalThisMonth += amt;
            } else {
                variableTotal += amt;
            }
        });
        
        currentMonthTotal = total; // For Donut Center

        const now = new Date();
        const isCurrentMonth = (selYear === now.getFullYear() && selMonth === (now.getMonth() + 1));
        const isPastMonth = (selYear < now.getFullYear()) || (selYear === now.getFullYear() && selMonth < (now.getMonth() + 1));

        let daysPassed, daysInMonth;
        if (isCurrentMonth) {
            daysPassed = now.getDate();
            daysInMonth = new Date(selYear, selMonth, 0).getDate();
        } else if (isPastMonth) {
            daysInMonth = new Date(selYear, selMonth, 0).getDate();
            daysPassed = daysInMonth;
        } else {
            daysPassed = 0; daysInMonth = 30;
        }

        const pastFixedCosts = {};
        fullDataset.forEach(e => {
            const d = new Date(e.date);
            if (d < new Date(now.getFullYear(), now.getMonth(), 1)) {
                if (FIXED_COST_SUBCATS.includes(e.subcategory) || e.category === "Investment") {
                    const key = `${d.getFullYear()}-${d.getMonth()}`;
                    pastFixedCosts[key] = (pastFixedCosts[key] || 0) + (parseFloat(e.amount) + parseFloat(e.surcharge));
                }
            }
        });

        const monthsCount = Object.keys(pastFixedCosts).length;
        const totalPastFixed = Object.values(pastFixedCosts).reduce((a, b) => a + b, 0);
        const avgFixedCost = monthsCount > 0 ? (totalPastFixed / monthsCount) : 0;

        const dailyAvg = daysPassed > 0 ? variableTotal / daysPassed : 0;
        const estimatedFixed = Math.max(fixedTotalThisMonth, avgFixedCost);
        const projected = isPastMonth ? total : (estimatedFixed + (dailyAvg * daysInMonth));

        document.getElementById('kpi-total').innerHTML = fmtMoney(total);
        document.getElementById('kpi-daily').innerHTML = fmtMoney(dailyAvg);
        document.getElementById('kpi-projected').innerHTML = isPastMonth ? "Closed" : fmtMoney(projected);

        // DYNAMIC ATMOSPHERE
        // Calculate historical average spending to set "HEAT" mode
        // Simple logic: If Projected > (Avg Fixed + (Avg Daily * 30)), turn up the heat.
        // For now, let's use a simpler heuristic: If Projected > 1.2 * Last Month's Spend
        // (Since we don't have extensive history yet, let's stick to Safe/Gold default)
        // BUT, if you want to test it, uncomment below:
        // if (projected > 50000) document.body.classList.add('mode-heat'); 
        // else document.body.classList.remove('mode-heat');
    }

    function updateQualityBar(data) {
        let needSum = 0, wantSum = 0, saveSum = 0, total = 0;
        data.forEach(e => {
            const amt = parseFloat(e.amount) + parseFloat(e.surcharge);
            total += amt;
            if(e.category === 'Investment') saveSum += amt;
            else if (e.necessity && e.necessity.indexOf('Need') !== -1) needSum += amt;
            else wantSum += amt;
        });

        qualityData = { need: needSum, want: wantSum, save: saveSum, total: total, needPct: 0, wantPct: 0, savePct: 0 };

        if (total === 0) {
            document.getElementById('bar-needs').style.width = '0%'; document.getElementById('bar-wants').style.width = '0%'; document.getElementById('bar-saves').style.width = '0%';
            document.getElementById('val-need').innerText = '0%'; document.getElementById('val-want').innerText = '0%'; document.getElementById('val-save').innerText = '0%';
            return;
        }

        const needPct = Math.round((needSum / total) * 100);
        const wantPct = Math.round((wantSum / total) * 100);
        const savePct = 100 - needPct - wantPct; 
        
        qualityData.needPct = needPct; qualityData.wantPct = wantPct; qualityData.savePct = savePct;

        document.getElementById('bar-needs').style.width = needPct + '%';
        document.getElementById('bar-wants').style.width = wantPct + '%';
        document.getElementById('bar-saves').style.width = savePct + '%';
        document.getElementById('val-need').innerText = needPct + '%';
        document.getElementById('val-want').innerText = wantPct + '%';
        document.getElementById('val-save').innerText = savePct + '%';
    }

    function updateDonutAndTable(data) {
        const totals = {}; let grandTotal = 0; donutBreakdownData = {};
        data.forEach(e => {
            const val = parseFloat(e.amount) + parseFloat(e.surcharge);
            totals[e.category] = (totals[e.category] || 0) + val;
            grandTotal += val;
            if (!donutBreakdownData[e.category]) donutBreakdownData[e.category] = {};
            donutBreakdownData[e.category][e.subcategory] = (donutBreakdownData[e.category][e.subcategory] || 0) + val;
        });

        // Update Living Donut Center
        document.getElementById('donut-val').innerText = fmtMoney(grandTotal);
        
        const labels = Object.keys(totals); const values = Object.values(totals);
        const tbody = document.getElementById('breakdown-table-body'); tbody.innerHTML = "";
        
        labels.forEach((cat, i) => {
            const row = document.createElement('tr');
            row.className = "clickable-row";
            row.onclick = () => openCategoryModal(cat);
            row.innerHTML = `<td><div class="td-cat-wrapper"><svg class="c-icon" style="width:16px;height:16px;"><use href="#icon-${cat}"></use></svg> ${cat}</div></td><td style="text-align:right; font-family:'Space Grotesk'" class="tabular">${fmtMoney(values[i])}</td>`;
            tbody.appendChild(row);
        });
        tbody.innerHTML += `<tr><td>TOTAL</td><td style="text-align:right; font-family:'Space Grotesk'" class="tabular">${fmtMoney(grandTotal)}</td></tr>`;

        const ctx = document.getElementById('donutChart').getContext('2d');
        if(donutChartInstance) donutChartInstance.destroy();
        const colorMap = { "Food": "#FF6348", "Utilities": "#1E90FF", "Travel": "#A55EEA", "Lifestyle": "#2ED573", "Investment": "#FFD700" };
        const bgColors = labels.map(l => colorMap[l] || "#95a5a6");
        if(labels.length === 0) return;

        donutChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 0, hoverOffset: 10 }] },
            options: { 
                layout: { padding: 20 }, responsive: true, maintainAspectRatio: false, cutout: '70%', 
                plugins: { 
                    legend: { position: 'right', labels: { usePointStyle: true, pointStyle: 'circle' } },
                    tooltip: { enabled: false, external: externalTooltipHandler }
                },
                // LIVING DONUT INTERACTION
                onHover: (event, elements) => {
                    const centerLabel = document.querySelector('#donut-center .dl-sub');
                    const centerVal = document.querySelector('#donut-center .dl-main');
                    if (elements && elements.length > 0) {
                        const index = elements[0].index;
                        centerLabel.innerText = labels[index];
                        centerVal.innerText = fmtMoney(values[index]);
                        centerVal.style.color = bgColors[index];
                    } else {
                        centerLabel.innerText = "Total";
                        centerVal.innerText = fmtMoney(grandTotal);
                        centerVal.style.color = "#fff";
                    }
                }
            }
        });
    }

    function updateLineChartAnnual(data) {
        const monthlyTotals = new Array(12).fill(0);
        data.forEach(e => monthlyTotals[new Date(e.date).getMonth()] += (parseFloat(e.amount) + parseFloat(e.surcharge)));
        renderChartBase(["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"], monthlyTotals);
    }

    function updateLineChartDaily(data, month, year) {
        const daysInMonth = new Date(year, month, 0).getDate();
        const dailyTotals = new Array(daysInMonth).fill(0);
        const labels = Array.from({length: daysInMonth}, (_, i) => i + 1); 
        data.forEach(e => {
            const day = new Date(e.date).getDate();
            dailyTotals[day - 1] += (parseFloat(e.amount) + parseFloat(e.surcharge));
        });
        renderChartBase(labels, dailyTotals);
    }

    function renderChartBase(labels, dataPoints) {
        const ctx = document.getElementById('lineChart').getContext('2d');
        if(lineChartInstance) lineChartInstance.destroy();
        const gradient = ctx.createLinearGradient(0, 0, 0, 400); gradient.addColorStop(0, 'rgba(240, 165, 0, 0.5)'); gradient.addColorStop(1, 'rgba(240, 165, 0, 0.0)');

        lineChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: 'Spent', data: dataPoints, borderColor: '#F0A500', backgroundColor: gradient, tension: 0.4, fill: true, pointBackgroundColor: '#000', pointBorderColor: '#F0A500', pointBorderWidth: 2, pointRadius: 4 }]
            },
            options: { layout: { padding: 20 }, responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false, external: externalTooltipHandler } }, scales: { y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { callback: (v) => '₹' + v } }, x: { grid: { display: false } } } }
        });
    }

    function fmtMoney(num) { return "\u20B9 " + num.toLocaleString('en-IN', { maximumFractionDigits: 0 }); }
    init();
</script>
</body>
</html>